#!/usr/bin/env python3
"""
PreciosCerca - Servidor Principal (Flask)
=========================================

Servidor Flask que proporciona una API REST para la app de lista de compras.
Soporta b√∫squeda de productos con filtro por supermercado.

Endpoints principales:
- GET /products?query=X&supermercado=Y - Buscar productos (filtro opcional)
- POST /lista - Agregar producto a lista
- GET /lista - Ver lista completa
- DELETE /lista/<id> - Eliminar de lista

Supermercados activos:
- Carrefour (API VTEX) ‚úÖ
- D√≠a % (API REST) ‚úÖ
- La Reina (HTML Scraping) ‚úÖ

Autor: PreciosCerca Team
Fecha: Noviembre 2025
"""

from flask import Flask, jsonify, request
import sys
import os

# Agregar el directorio backend al path de Python
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

print("üöÄ Inicializando PreciosCerca Server...")
print("=" * 60)
print("VERSI√ìN CON LA GALLEGA - 16:36 HS")
print("=" * 60)

try:
    from productos.scrapers.scraper_carrefour import ScraperCarrefour
    from productos.scrapers.scraper_dia import ScraperDia
    from productos.scrapers.scraper_lareina import ScraperLaReina
    from productos.scrapers.scraper_lagallega import ScraperLaGallega
    from lista_compras import lista_compras_global
    from productos.services import buscar_productos_similares
    print("‚úÖ Scrapers cargados: Carrefour, D√≠a %, La Reina, La Gallega")
    print("‚úÖ Sistema de lista de compras inicializado")
except Exception as e:
    print(f"‚ùå Error cargando scrapers: {e}")
    sys.exit(1)

app = Flask(__name__)
print("üêõ DEBUG: Flask app creada")

# Inicializar scrapers disponibles
scrapers = {
    'carrefour': ScraperCarrefour(),
    'dia': ScraperDia(),
    'lareina': ScraperLaReina(),
    'lagallega': ScraperLaGallega()
}

print(f"‚úÖ {len(scrapers)} scrapers activos con b√∫squeda multi-palabra")
print(f"üêõ DEBUG: Scrapers dict keys = {list(scrapers.keys())}")

# ========== ENDPOINT PRINCIPAL: BUSCAR PRODUCTOS ==========
@app.route('/products', methods=['GET'])
def buscar_productos():
    """
    Endpoint principal para buscar productos con filtro opcional por supermercado.
    
    Par√°metros GET:
    - query (obligatorio): t√©rmino de b√∫squeda (ej: "leche", "pan", "dulce de leche")
    - supermercado (opcional): filtrar por "carrefour", "dia" o "lareina"
    
    Ejemplos:
    - /products?query=leche&supermercado=carrefour  (solo Carrefour)
    - /products?query=pan&supermercado=dia          (solo D√≠a)
    - /products?query=aceite                        (todos los supers)
    
    Retorna JSON con productos ordenados por precio:
    {
        "query": "leche",
        "total_encontrados": 50,
        "supermercados_consultados": ["Carrefour"],
        "productos_por_supermercado": {"Carrefour": 50},
        "resultados": [...]
    }
    """
    query = request.args.get('query', request.args.get('q', 'leche'))
    filtro_super = request.args.get('supermercado', '').lower()
    
    if filtro_super:
        print(f"üîç B√∫squeda: '{query}' en {filtro_super.upper()}")
    else:
        print(f"üîç B√∫squeda: '{query}' en todos los supermercados")
    
    try:
        print("  üêõ DEBUG - Entrando al bloque try")
        todos_los_productos = []
        supermercados_consultados = []
        productos_por_supermercado = {}
        
        # Determinar qu√© scrapers usar
        scrapers_a_usar = {}
        if filtro_super:
            # Buscar solo en el supermercado especificado
            print(f"  üêõ DEBUG - filtro_super='{filtro_super}'")
            print(f"  üêõ DEBUG - scrapers disponibles: {list(scrapers.keys())}")
            print(f"  üêõ DEBUG - '{filtro_super}' in scrapers = {filtro_super in scrapers}")
            if filtro_super in scrapers:
                scrapers_a_usar[filtro_super] = scrapers[filtro_super]
                print(f"  üêõ DEBUG - Scraper encontrado y agregado")
            else:
                return jsonify({
                    'error': f'Supermercado "{filtro_super}" no disponible',
                    'supermercados_disponibles': list(scrapers.keys())
                }), 400
        else:
            # Buscar en todos
            scrapers_a_usar = scrapers
        
        # üêõ DEBUG: Ver qu√© scrapers est√°n disponibles ANTES de buscar
        print(f"  üêõ DEBUG - Scrapers a usar: {list(scrapers_a_usar.keys())}")
        
        # Buscar en Carrefour
        if 'carrefour' in scrapers_a_usar:
            print("  üîç Buscando en Carrefour...")
            carrefour_productos = scrapers_a_usar['carrefour'].buscar_productos(query)
            # Aplicar filtro para b√∫squedas de m√∫ltiples palabras
            carrefour_productos = buscar_productos_similares(query, carrefour_productos)
            todos_los_productos.extend(carrefour_productos)
            supermercados_consultados.append('Carrefour')
            productos_por_supermercado['Carrefour'] = len(carrefour_productos)
            print(f"  ‚úÖ Carrefour: {len(carrefour_productos)} productos")
        
        # Buscar en D√≠a
        if 'dia' in scrapers_a_usar:
            print("  üîç Buscando en D√≠a %...")
            dia_productos = scrapers_a_usar['dia'].buscar_productos(query)
            # Aplicar filtro para b√∫squedas de m√∫ltiples palabras
            dia_productos = buscar_productos_similares(query, dia_productos)
            todos_los_productos.extend(dia_productos)
            supermercados_consultados.append('D√≠a %')
            productos_por_supermercado['D√≠a %'] = len(dia_productos)
            print(f"  ‚úÖ D√≠a %: {len(dia_productos)} productos")
        
        # Buscar en La Reina
        if 'lareina' in scrapers_a_usar:
            print("  üîç Buscando en La Reina...")
            lareina_productos = scrapers_a_usar['lareina'].buscar_productos(query)
            # Aplicar filtro para b√∫squedas de m√∫ltiples palabras
            lareina_productos = buscar_productos_similares(query, lareina_productos)
            todos_los_productos.extend(lareina_productos)
            supermercados_consultados.append('La Reina')
            productos_por_supermercado['La Reina'] = len(lareina_productos)
            print(f"  ‚úÖ La Reina: {len(lareina_productos)} productos")
        
        # DEBUG: Ver qu√© scrapers est√°n disponibles
        print(f"  üêõ DEBUG - Scrapers a usar: {list(scrapers_a_usar.keys())}")
        
        # Buscar en La Gallega
        if 'lagallega' in scrapers_a_usar:
            print("  üîç Buscando en La Gallega...")
            lagallega_productos = scrapers_a_usar['lagallega'].buscar_productos(query)
            # Aplicar filtro para b√∫squedas de m√∫ltiples palabras
            lagallega_productos = buscar_productos_similares(query, lagallega_productos)
            todos_los_productos.extend(lagallega_productos)
            supermercados_consultados.append('La Gallega')
            productos_por_supermercado['La Gallega'] = len(lagallega_productos)
            print(f"  ‚úÖ La Gallega: {len(lagallega_productos)} productos")
        
        # Ordenar por precio (m√°s barato primero)
        todos_los_productos.sort(key=lambda x: x['precio'])
        
        # Convertir al formato que espera la app Android
        resultados = []
        for producto in todos_los_productos:
            resultados.append({
                'nombre': producto['nombre'],
                'precio': producto['precio'],
                'supermercado': producto['supermercado'],
                'fecha': '2025-11-03',
                'relevancia': 1.0,
                'url': producto.get('url', ''),
                'imagen': producto.get('imagen', '')  # Agregar imagen
            })
        
        print(f"‚úÖ {len(resultados)} productos encontrados")
        
        # Respuesta en formato Android
        response = {
            'query': query,
            'total_encontrados': len(resultados),
            'supermercados_consultados': supermercados_consultados,
            'productos_por_supermercado': productos_por_supermercado,
            'resultados': resultados
        }
        
        return jsonify(response)
        
    except Exception as e:
        print(f"‚ùå Error en b√∫squeda: {e}")
        return jsonify({
            'error': str(e),
            'query': query,
            'total_encontrados': 0,
            'supermercados_consultados': [],
            'productos_por_supermercado': {},
            'resultados': []
        }), 500

@app.route('/lagallega', methods=['GET'])
def buscar_productos_lagallega():
    """
    Endpoint EXCLUSIVO para La Gallega (temporal para debug).
    GET /lagallega?query=leche
    """
    query = request.args.get('query', request.args.get('q', 'leche'))
    print(f"üîç [LA GALLEGA EXCLUSIVO] B√∫squeda: '{query}'")
    
    try:
        print("  üêõ Llamando a scraper_lagallega.buscar_productos()...")
        lagallega_productos = scrapers['lagallega'].buscar_productos(query)
        print(f"  üêõ Scraper retorn√≥ {len(lagallega_productos)} productos")
        
        # Aplicar filtro para b√∫squedas de m√∫ltiples palabras
        lagallega_productos = buscar_productos_similares(query, lagallega_productos)
        print(f"  üêõ Despu√©s del filtro: {len(lagallega_productos)} productos")
        
        # Ordenar por precio
        lagallega_productos.sort(key=lambda x: x['precio'])
        
        # Convertir al formato Android
        resultados = []
        for producto in lagallega_productos:
            resultados.append({
                'nombre': producto['nombre'],
                'precio': producto['precio'],
                'supermercado': producto['supermercado'],
                'fecha': '2025-11-03',
                'relevancia': 1.0,
                'url': producto.get('url', ''),
                'imagen': producto.get('imagen', '')
            })
        
        print(f"‚úÖ [LA GALLEGA] {len(resultados)} productos encontrados")
        
        return jsonify({
            'query': query,
            'total_encontrados': len(resultados),
            'supermercados_consultados': ['La Gallega'],
            'productos_por_supermercado': {'La Gallega': len(resultados)},
            'resultados': resultados
        })
        
    except Exception as e:
        print(f"‚ùå [LA GALLEGA] Error: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'error': str(e),
            'query': query,
            'total_encontrados': 0,
            'supermercados_consultados': [],
            'productos_por_supermercado': {},
            'resultados': []
        }), 500

# TEMPORALMENTE COMENTADO - Funciones faltantes
@app.route('/products-cercanos', methods=['GET'])
def buscar_productos_cercanos():
    """Busca productos en supermercados con sucursales cercanas al usuario (GPS) - EN DESARROLLO"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'B√∫squeda de productos cercanos estar√° disponible pr√≥ximamente'
    }), 501

@app.route('/health', methods=['GET'])
def health_check():
    """Endpoint de salud para verificar que el servidor funciona."""
    return jsonify({
        'status': 'OK', 
        'message': 'PreciosCerca Server funcionando',
        'scrapers_disponibles': list(scrapers.keys()),
        'version': '1.0.0'
    })

@app.route('/', methods=['GET'])
def info():
    """Informaci√≥n b√°sica del servidor."""
    return jsonify({
        'app': 'PreciosCerca API',
        'descripcion': 'API para comparar precios en supermercados argentinos',
        'supermercados_soportados': list(scrapers.keys()),
        'endpoints': {
            '/products?query=TERMINO': 'Buscar productos en todos los supermercados',
            '/products-cercanos?query=TERMINO&lat=LAT&lng=LNG&radio=KM': 'Buscar solo en supermercados cercanos (EN DESARROLLO)',
            '/sucursal-cercana?supermercado=NOMBRE&lat=LAT&lng=LNG': 'Encontrar sucursal m√°s cercana',
            '/sucursales?supermercado=NOMBRE': 'Listar sucursales de un supermercado',
            '/health': 'Estado del servidor'
        }
    })

@app.route('/sucursal-cercana', methods=['GET'])
def sucursal_cercana():
    """Busca sucursal m√°s cercana (EN DESARROLLO - solo La Gallega)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'B√∫squeda de sucursales estar√° disponible pr√≥ximamente'
    }), 501

@app.route('/sucursales', methods=['GET'])
def listar_sucursales():
    """Lista sucursales (EN DESARROLLO - solo La Gallega)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'Listado de sucursales estar√° disponible pr√≥ximamente'
    }), 501


# ============================================================================
# ENDPOINTS DE LISTA DE COMPRAS
# ============================================================================

@app.route('/lista-compras', methods=['GET'])
def obtener_lista_compras():
    """Obtiene todos los items de la lista de compras"""
    try:
        items = lista_compras_global.obtener_items()
        return jsonify({
            'items': items,
            'total_items': lista_compras_global.cantidad_items()
        })
    except Exception as e:
        print(f"‚ùå Error obteniendo lista de compras: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/agregar', methods=['POST'])
def agregar_a_lista():
    """
    Agrega un producto a la lista de compras
    Body JSON: {"nombre": "Leche", "cantidad": 1, "precio": 150.50, "supermercado": "Carrefour", "imagen": "url"}
    """
    try:
        data = request.get_json()
        nombre = data.get('nombre')
        cantidad = data.get('cantidad', 1)
        precio = data.get('precio', 0.0)
        supermercado = data.get('supermercado', '')
        imagen = data.get('imagen', '')
        
        if not nombre:
            return jsonify({'error': 'Nombre de producto requerido'}), 400
        
        resultado = lista_compras_global.agregar_producto(
            nombre, cantidad, precio, supermercado, imagen
        )
        return jsonify(resultado)
        
    except Exception as e:
        print(f"‚ùå Error agregando a lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/eliminar', methods=['DELETE'])
def eliminar_de_lista():
    """
    Elimina un producto de la lista de compras
    Body JSON: {"nombre": "Leche"}
    """
    try:
        data = request.get_json()
        nombre = data.get('nombre')
        
        if not nombre:
            return jsonify({'error': 'Nombre de producto requerido'}), 400
        
        resultado = lista_compras_global.eliminar_producto(nombre)
        return jsonify(resultado)
        
    except Exception as e:
        print(f"‚ùå Error eliminando de lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/limpiar', methods=['POST'])
def limpiar_lista():
    """Limpia todos los items de la lista de compras"""
    try:
        lista_compras_global.limpiar()
        return jsonify({
            'status': 'ok',
            'mensaje': 'Lista de compras limpiada'
        })
    except Exception as e:
        print(f"‚ùå Error limpiando lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/comparar', methods=['GET'])
def comparar_lista():
    """Compara precios de la lista entre supermercados (EN DESARROLLO)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'La comparaci√≥n autom√°tica estar√° disponible pr√≥ximamente'
    }), 501


print("üêõ DEBUG: Endpoint /lagallega registrado")
print(f"üêõ DEBUG: Total endpoints registrados en app: {len(app.url_map._rules)}")

if __name__ == '__main__':
    print("\n" + "="*60)
    print("üí∞ MI LISTA DE PRECIOS - API SERVER")
    print("="*60)
    print("üìç URL: http://localhost:8000")
    print("üõí Supermercados: Carrefour, D√≠a %, La Reina, La Gallega")
    print("üì± Compatible con app Android Mi Lista de Precios")
    print("üîç Buscar: /products?query=PRODUCTO&supermercado=SUPER")
    print("üõí Lista: /lista-compras (GET/POST/DELETE)")
    print("üêõ Endpoint especial: /lagallega?query=PRODUCTO")
    print("="*60)
    
    # Listar todos los endpoints registrados
    print("\nüîß Endpoints registrados:")
    for rule in app.url_map.iter_rules():
        print(f"   {rule.rule} -> {rule.endpoint}")
    print("="*60 + "\n")
    
    app.run(host='0.0.0.0', port=8000, debug=False)

@app.route('/health', methods=['GET'])
def health_check():
    """Endpoint de salud para verificar que el servidor funciona."""
    return jsonify({
        'status': 'OK',
        'message': 'PreciosCerca Server funcionando',
        'scrapers_disponibles': list(scrapers.keys()),
        'version': '1.0.0'
    })

@app.route('/', methods=['GET'])
def info():
    """Informaci√≥n b√°sica del servidor."""
    return jsonify({
        'app': 'PreciosCerca API',
        'descripcion': 'API para comparar precios en supermercados argentinos',
        'supermercados_soportados': list(scrapers.keys()),
        'endpoints': {
            '/products?query=TERMINO': 'Buscar productos en todos los supermercados',
            '/products-cercanos?query=TERMINO&lat=LAT&lng=LNG&radio=KM': 'Buscar solo en supermercados cercanos (NEW)',
            '/sucursal-cercana?supermercado=NOMBRE&lat=LAT&lng=LNG': 'Encontrar sucursal m√°s cercana',
            '/sucursales?supermercado=NOMBRE': 'Listar sucursales de un supermercado',
            '/health': 'Estado del servidor'
        }
    })

@app.route('/sucursal-cercana', methods=['GET'])
def sucursal_cercana():
    """Busca sucursal m√°s cercana (EN DESARROLLO - solo La Gallega)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'B√∫squeda de sucursales estar√° disponible pr√≥ximamente'
    }), 501

@app.route('/sucursales', methods=['GET'])
def listar_sucursales():
    """Lista sucursales (EN DESARROLLO - solo La Gallega)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'Listado de sucursales estar√° disponible pr√≥ximamente'
    }), 501


# ============================================================================
# ENDPOINTS DE LISTA DE COMPRAS
# ============================================================================

@app.route('/lista-compras', methods=['GET'])
def obtener_lista_compras():
    """Obtiene todos los items de la lista de compras"""
    try:
        items = lista_compras_global.obtener_items()
        return jsonify({
            'items': items,
            'total_items': lista_compras_global.cantidad_items()
        })
    except Exception as e:
        print(f"‚ùå Error obteniendo lista de compras: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/agregar', methods=['POST'])
def agregar_a_lista():
    """
    Agrega un producto a la lista de compras
    Body JSON: {"nombre": "Leche", "cantidad": 1, "precio": 150.50, "supermercado": "Carrefour", "imagen": "url"}
    """
    try:
        data = request.get_json()
        nombre = data.get('nombre')
        cantidad = data.get('cantidad', 1)
        precio = data.get('precio', 0.0)
        supermercado = data.get('supermercado', '')
        imagen = data.get('imagen', '')
        
        if not nombre:
            return jsonify({'error': 'Nombre de producto requerido'}), 400
        
        resultado = lista_compras_global.agregar_producto(
            nombre, cantidad, precio, supermercado, imagen
        )
        return jsonify(resultado)
        
    except Exception as e:
        print(f"‚ùå Error agregando a lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/eliminar', methods=['DELETE'])
def eliminar_de_lista():
    """
    Elimina un producto de la lista de compras
    Body JSON: {"nombre": "Leche"}
    """
    try:
        data = request.get_json()
        nombre = data.get('nombre')
        
        if not nombre:
            return jsonify({'error': 'Nombre de producto requerido'}), 400
        
        resultado = lista_compras_global.eliminar_producto(nombre)
        return jsonify(resultado)
        
    except Exception as e:
        print(f"‚ùå Error eliminando de lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/limpiar', methods=['POST'])
def limpiar_lista():
    """Limpia todos los items de la lista de compras"""
    try:
        lista_compras_global.limpiar()
        return jsonify({
            'status': 'ok',
            'mensaje': 'Lista de compras limpiada'
        })
    except Exception as e:
        print(f"‚ùå Error limpiando lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/comparar', methods=['GET'])
def comparar_lista():
    """Compara precios de la lista entre supermercados (EN DESARROLLO)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'La comparaci√≥n autom√°tica estar√° disponible pr√≥ximamente'
    }), 501


print("üêõ DEBUG: Endpoint /lagallega registrado")
print(f"üêõ DEBUG: Total endpoints registrados en app: {len(app.url_map._rules)}")

if __name__ == '__main__':
    print("\n" + "="*60)
    print("üí∞ MI LISTA DE PRECIOS - API SERVER")
    print("="*60)
    print("üìç URL: http://localhost:8000")
    print("üõí Supermercados: Carrefour, D√≠a %, La Reina, La Gallega")
    print("üì± Compatible con app Android Mi Lista de Precios")
    print("üîç Buscar: /products?query=PRODUCTO&supermercado=SUPER")
    print("üõí Lista: /lista-compras (GET/POST/DELETE)")
    print("üêõ Endpoint especial: /lagallega?query=PRODUCTO")
    print("="*60)
    
    # Listar todos los endpoints registrados
    print("\nüîß Endpoints registrados:")
    for rule in app.url_map.iter_rules():
        print(f"   {rule.rule} -> {rule.endpoint}")
    print("="*60 + "\n")
    
    app.run(host='0.0.0.0', port=8000, debug=False)

    if lat is None or lng is None:
        return jsonify({
            'error': 'Se requieren par√°metros: query, lat, lng'
        }), 400
    
    print(f"üîç B√∫squeda cercana: '{query}' en ({lat}, {lng}) - Radio: {radio}km")
    
    try:
        # Detectar ciudad del usuario
        info_ciudad = detectar_ciudad_usuario(lat, lng)
        ciudad_usuario = info_ciudad['ciudad']
        distancia_ciudad = info_ciudad['distancia_km']
        
        print(f"  üìç Ciudad detectada: {ciudad_usuario} (a {distancia_ciudad}km del centro)")
        
        # Obtener supermercados con sucursales cercanas
        supermercados_cercanos = obtener_supermercados_cercanos(lat, lng, radio)
        
        if not supermercados_cercanos:
            print(f"  ‚ö†Ô∏è No hay supermercados dentro de {radio}km")
            return jsonify({
                'query': query,
                'lat': lat,
                'lng': lng,
                'radio_km': radio,
                'ciudad_detectada': ciudad_usuario,
                'distancia_ciudad_km': distancia_ciudad,
                'mensaje': f'No hay supermercados con sucursales dentro de {radio}km de tu ubicaci√≥n en {ciudad_usuario}',
                'total_encontrados': 0,
                'supermercados_consultados': [],
                'productos_por_supermercado': {},
                'resultados': []
            })
        
        print(f"  üìç Supermercados con sucursales cercanas: {', '.join(supermercados_cercanos)}")
        
        # Obtener info detallada de sucursales cercanas y calcular distancia m√≠nima por supermercado
        sucursales_info = filtrar_sucursales_por_radio(lat, lng, radio)
        distancias_supermercados = {}
        
        # Mostrar sucursales encontradas y guardar distancia m√≠nima
        for super_nombre, sucursales_lista in sucursales_info.items():
            sucursal_mas_cercana = sucursales_lista[0]  # Ya est√°n ordenadas por distancia
            distancias_supermercados[super_nombre] = sucursal_mas_cercana['distancia_km']
            print(f"    ‚Ä¢ {super_nombre}: {len(sucursales_lista)} sucursal(es), m√°s cercana a {sucursal_mas_cercana['distancia_km']}km")
        
        # Ordenar supermercados por distancia (m√°s cercano primero)
        supermercados_ordenados = sorted(
            supermercados_cercanos,
            key=lambda s: distancias_supermercados.get(s, float('inf'))
        )
        
        supermercado_mas_cercano = supermercados_ordenados[0] if supermercados_ordenados else None
        distancia_mas_cercano = distancias_supermercados.get(supermercado_mas_cercano, 0) if supermercado_mas_cercano else 0
        
        print(f"  üèÜ Supermercado m√°s cercano: {supermercado_mas_cercano} a {distancia_mas_cercano:.2f}km")
        
        # Buscar productos solo en supermercados cercanos
        todos_los_productos = []
        supermercados_consultados = []
        productos_por_supermercado = {}
        
        # Mapeo de nombres de supermercados a keys de scrapers
        MAPEO_SCRAPERS = {
            'La Gallega': 'lagallega'
            # 'Carrefour': 'carrefour',
            # 'D√≠a %': 'dia',
            # 'La Reina': 'lareina'
        }
        
        # Buscar en supermercados en orden de cercan√≠a
        for nombre_super in supermercados_ordenados:
            scraper_key = MAPEO_SCRAPERS.get(nombre_super)
            
            # Solo buscar si tenemos scraper funcional para ese supermercado
            if scraper_key and scraper_key in scrapers:
                scraper = scrapers[scraper_key]
                
                print(f"  üîç Buscando en {nombre_super}...")
                try:
                    productos = scraper.buscar_productos(query)
                    if productos:
                        # Cambiar el nombre del supermercado en los resultados
                        # y agregar la distancia de la sucursal m√°s cercana
                        for prod in productos:
                            prod['supermercado'] = nombre_super
                            prod['distancia_sucursal_km'] = distancias_supermercados.get(nombre_super, 0)
                        todos_los_productos.extend(productos)
                        supermercados_consultados.append(nombre_super)
                        productos_por_supermercado[nombre_super] = len(productos)
                        print(f"  ‚úÖ {nombre_super}: {len(productos)} productos")
                    else:
                        print(f"  ‚ÑπÔ∏è {nombre_super}: sin resultados para '{query}'")
                except Exception as e:
                    print(f"  ‚ö†Ô∏è {nombre_super}: error al buscar - {e}")
            else:
                print(f"  ‚ö†Ô∏è {nombre_super}: scraper no disponible (sucursales cercanas pero sin scraper funcional)")
        
        # Ordenar productos: primero por distancia del supermercado (m√°s cercano primero), luego por precio
        todos_los_productos.sort(key=lambda x: (x.get('distancia_sucursal_km', float('inf')), x['precio']))
        
        # Formatear respuesta
        resultados = []
        for producto in todos_los_productos:
            resultados.append({
                'nombre': producto['nombre'],
                'precio': producto['precio'],
                'supermercado': producto['supermercado'],
                'distancia_sucursal_km': producto.get('distancia_sucursal_km', 0),
                'fecha': '2025-10-30',
                'relevancia': 1.0,
                'url': producto.get('url', '')
            })
        
        print(f"‚úÖ {len(resultados)} productos encontrados en {len(supermercados_consultados)} supermercado(s) cerca de {ciudad_usuario}")
        
        response = {
            'query': query,
            'lat': lat,
            'lng': lng,
            'radio_km': radio,
            'ciudad_detectada': ciudad_usuario,
            'distancia_ciudad_km': distancia_ciudad,
            'supermercado_mas_cercano': supermercado_mas_cercano,
            'distancia_supermercado_mas_cercano_km': distancia_mas_cercano,
            'total_encontrados': len(resultados),
            'supermercados_consultados': supermercados_consultados,
            'productos_por_supermercado': productos_por_supermercado,
            'sucursales_cercanas': sucursales_info,
            'resultados': resultados
        }
        
        return jsonify(response)
        
    except Exception as e:
        print(f"‚ùå Error en b√∫squeda cercana: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({
            'error': str(e),
            'query': query,
            'total_encontrados': 0,
            'resultados': []
        }), 500

@app.route('/health', methods=['GET'])
def health_check():
    """Endpoint de salud para verificar que el servidor funciona."""
    return jsonify({
        'status': 'OK', 
        'message': 'PreciosCerca Server funcionando',
        'scrapers_disponibles': list(scrapers.keys()),
        'version': '1.0.0'
    })

@app.route('/', methods=['GET'])
def info():
    """Informaci√≥n b√°sica del servidor."""
    return jsonify({
        'app': 'PreciosCerca API',
        'descripcion': 'API para comparar precios en supermercados argentinos',
        'supermercados_soportados': list(scrapers.keys()),
        'endpoints': {
            '/products?query=TERMINO': 'Buscar productos en todos los supermercados',
            '/products-cercanos?query=TERMINO&lat=LAT&lng=LNG&radio=KM': 'Buscar solo en supermercados cercanos (NEW)',
            '/sucursal-cercana?supermercado=NOMBRE&lat=LAT&lng=LNG': 'Encontrar sucursal m√°s cercana',
            '/sucursales?supermercado=NOMBRE': 'Listar sucursales de un supermercado',
            '/health': 'Estado del servidor'
        }
    })

@app.route('/sucursal-cercana', methods=['GET'])
def sucursal_cercana():
    """Busca sucursal m√°s cercana (EN DESARROLLO - solo La Gallega)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'B√∫squeda de sucursales estar√° disponible pr√≥ximamente'
    }), 501

@app.route('/sucursales', methods=['GET'])
def listar_sucursales():
    """Lista sucursales (EN DESARROLLO - solo La Gallega)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'Listado de sucursales estar√° disponible pr√≥ximamente'
    }), 501


# ============================================================================
# ENDPOINTS DE LISTA DE COMPRAS
# ============================================================================

@app.route('/lista-compras', methods=['GET'])
def obtener_lista_compras():
    """Obtiene todos los items de la lista de compras"""
    try:
        items = lista_compras_global.obtener_items()
        return jsonify({
            'items': items,
            'total_items': lista_compras_global.cantidad_items()
        })
    except Exception as e:
        print(f"‚ùå Error obteniendo lista de compras: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/agregar', methods=['POST'])
def agregar_a_lista():
    """
    Agrega un producto a la lista de compras
    Body JSON: {"nombre": "Leche", "cantidad": 1, "precio": 150.50, "supermercado": "Carrefour", "imagen": "url"}
    """
    try:
        data = request.get_json()
        nombre = data.get('nombre')
        cantidad = data.get('cantidad', 1)
        precio = data.get('precio', 0.0)
        supermercado = data.get('supermercado', '')
        imagen = data.get('imagen', '')
        
        if not nombre:
            return jsonify({'error': 'Nombre de producto requerido'}), 400
        
        resultado = lista_compras_global.agregar_producto(
            nombre, cantidad, precio, supermercado, imagen
        )
        return jsonify(resultado)
        
    except Exception as e:
        print(f"‚ùå Error agregando a lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/eliminar', methods=['DELETE'])
def eliminar_de_lista():
    """
    Elimina un producto de la lista de compras
    Body JSON: {"nombre": "Leche"}
    """
    try:
        data = request.get_json()
        nombre = data.get('nombre')
        
        if not nombre:
            return jsonify({'error': 'Nombre de producto requerido'}), 400
        
        resultado = lista_compras_global.eliminar_producto(nombre)
        return jsonify(resultado)
        
    except Exception as e:
        print(f"‚ùå Error eliminando de lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/limpiar', methods=['POST'])
def limpiar_lista():
    """Limpia todos los items de la lista de compras"""
    try:
        lista_compras_global.limpiar()
        return jsonify({
            'status': 'ok',
            'mensaje': 'Lista de compras limpiada'
        })
    except Exception as e:
        print(f"‚ùå Error limpiando lista: {e}")
        return jsonify({'error': str(e)}), 500


@app.route('/lista-compras/comparar', methods=['GET'])
def comparar_lista():
    """Compara precios de la lista entre supermercados (EN DESARROLLO)"""
    return jsonify({
        'error': 'Funci√≥n en desarrollo',
        'mensaje': 'La comparaci√≥n autom√°tica estar√° disponible pr√≥ximamente'
    }), 501


print("üêõ DEBUG: Endpoint /products-lagallega registrado")
print(f"üêõ DEBUG: Total endpoints registrados en app: {len(app.url_map._rules)}")

if __name__ == '__main__':
    print("\n" + "="*60)
    print("üí∞ MI LISTA DE PRECIOS - API SERVER")
    print("="*60)
    print("üìç URL: http://localhost:8000")
    print("üõí Supermercados: Carrefour, D√≠a %, La Reina, La Gallega")
    print("üì± Compatible con app Android Mi Lista de Precios")
    print("üîç Buscar: /products?query=PRODUCTO&supermercado=SUPER")
    print("üõí Lista: /lista-compras (GET/POST/DELETE)")
    print("üêõ Endpoint especial: /lagallega?query=PRODUCTO")
    print("="*60)
    
    # Listar todos los endpoints registrados
    print("\nüîß Endpoints registrados:")
    for rule in app.url_map.iter_rules():
        print(f"   {rule.rule} -> {rule.endpoint}")
    print("="*60 + "\n")
    
    app.run(host='0.0.0.0', port=8000, debug=False)